name: CI

# 2.1 â€“ Gatilhos
on:
  push:
    branches: [ main, develop ]
  pull_request:

# 2.2 â€“ PermissÃµes mÃ­nimas (boa prÃ¡tica de seguranÃ§a)
permissions:
  contents: read                      # checkout
  pull-requests: write                # comentÃ¡rios (Ruff, Codecov)

jobs:
  test:
    strategy:                         # ğŸŒ Matrix SO + Python
      # fail-fast: true                 # â¬…ï¸  para tudo na 1Âª falha (âš¡)
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']

    runs-on: ${{ matrix.os }}

    env:                              # variÃ¡veis usadas nos testes
      PYTHON_KEYRING_BACKEND: keyring.backends.fail.Keyring  # evita prompt do Poetry
      ENVIRONMENT: test               # seu Settings() pega .env.test se existir

    steps:
      # 1ï¸âƒ£  Checkout
      - uses: actions/checkout@v4

      # 2ï¸âƒ£  Setup Python conforme a matrix
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'                # Poetry cria venv prÃ³prio â†’ ok

      # 3ï¸âƒ£  Cache Poetry + virtualenv
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.virtualenvs
            ~\AppData\Local\pypoetry\Cache\virtualenvs
          key: ${{ runner.os }}-poetry-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}

      # 4ï¸âƒ£  Instala dependÃªncias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install --with dev --no-interaction

      # 5ï¸âƒ£  Linter / formatador (Ruff)
      - name: Run Ruff (lint + format)
        run: poetry run ruff check --output-format=github .
        continue-on-error: true     # âš ï¸ nÃ£o para o job

      # 6ï¸âƒ£   (PyUpgrade)
      - name: PyUpgrade (sugere modernizaÃ§Ã£o)
        run: poetry run pyupgrade --py312-plus --exit-zero-even-if-changed $(git ls-files '*.py')
        continue-on-error: true     # âš ï¸ nÃ£o para o job

      # 7ï¸âƒ£  Type (MyPy)
      - name: MyPy (type checking)
        run: poetry run mypy app
        continue-on-error: true     # âš ï¸ nÃ£o para o job

      # 8ï¸âƒ£   (Bandit)
      - name: Bandit (security)
        run: poetry run bandit -q -r app -lll
        continue-on-error: true     # âš ï¸ nÃ£o para o job

      # 6ï¸âƒ£  Testes com fail-fast e cobertura â‰¥ 85 % -> testes vÃªm depois dos linters
      - name: Run Pytest
        shell: bash                         # <-- forÃ§a bash em qualquer runner
        run: |
          poetry run pytest --cov=app \
                            --cov-report=xml \
                            --cov-report=term-missing \
                            --cov-report=html \
                            --cov-fail-under=80
        continue-on-error: true     # âš ï¸ nÃ£o para o job

      # 7ï¸âƒ£ (Opcional) Envia cobertura
      - name: Upload coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
